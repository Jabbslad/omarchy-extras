#!/bin/bash

# Tailscale status for Waybar
# Outputs current status as JSON and exits

# Check if tailscale is installed
if ! command -v tailscale &>/dev/null; then
  echo '{"text": "", "class": "not-installed", "tooltip": "Tailscale not installed"}'
  exit 0
fi

# Check if tailscaled service is running
if ! systemctl is-active tailscaled.service &>/dev/null; then
  echo '{"text": "", "class": "not-running", "tooltip": "Tailscale service not running"}'
  exit 0
fi

# Get tailscale status
STATUS=$(tailscale status --json 2>/dev/null)

if [ -z "$STATUS" ]; then
  echo '{"text": "○", "class": "disconnected", "tooltip": "Tailscale: Disconnected"}'
  exit 0
fi

# Parse the JSON to check if we're connected
BACKEND_STATE=$(echo "$STATUS" | jq -r '.BackendState' 2>/dev/null)
TAILSCALE_IP=$(echo "$STATUS" | jq -r '.Self.TailscaleIPs[0] // empty' 2>/dev/null)
NETWORK_NAME=$(echo "$STATUS" | jq -r '.MagicDNSSuffix // empty' 2>/dev/null | sed 's/\.ts\.net$//')

# Determine icon based on state
if [ "$BACKEND_STATE" = "Running" ] && [ -n "$TAILSCALE_IP" ]; then
  # Connected
  ICON="◉"
  CLASS="connected"
  
  # Format tooltip
  if [ -n "$NETWORK_NAME" ]; then
    TOOLTIP="Tailscale: $TAILSCALE_IP\nNetwork: $NETWORK_NAME"
  else
    TOOLTIP="Tailscale: $TAILSCALE_IP"
  fi
else
  # Disconnected
  ICON="○"
  CLASS="disconnected"
  TOOLTIP="Tailscale: Disconnected"
fi

# Output JSON for waybar
echo "{\"text\": \"$ICON\", \"class\": \"$CLASS\", \"tooltip\": \"$TOOLTIP\"}"